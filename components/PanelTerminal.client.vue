<script setup lang="ts">
import 'xterm/css/xterm.css'
import { Terminal } from 'xterm'
import { FitAddon } from 'xterm-addon-fit'

const props = defineProps<{
  stream?: ReadableStream
}>()

const root = ref<HTMLDivElement>()
const terminal = new Terminal({
  customGlyphs: true,
})
const fitAddon = new FitAddon()
terminal.loadAddon(fitAddon)

watch(
  () => props.stream,
  (s) => {
    if (!s)
      return
    const reader = s.getReader()
    function read() {
      reader.read().then(({ done, value }) => {
        terminal.write(value)
        if (!done)
          read()
      })
    }
    read()
  },
  { flush: 'sync', immediate: true },
)

useResizeObserver(root, useDebounceFn(() => fitAddon.fit(), 200))

const stop = watch(
  () => root.value,
  (el) => {
    if (!el)
      return
    terminal.open(el)
    terminal.write('\n')
    fitAddon.fit()
    stop()
  },
)
function hiddenTerminal() {
  const panelSizeEditor = usePanelCookie('nuxt-playground-panel-editor', 30)
  const panelSizeFrame = usePanelCookie('nuxt-playground-panel-frame', 30)
  const panelSizeTerminal = usePanelCookie('nuxt-playground-panel-terminal', 40)
  panelSizeTerminal.value = 0
  panelSizeFrame.value = 100 - panelSizeEditor.value!
}

onMounted(() => {
  terminal.open(root.value!)
  terminal.write('\n')
  fitAddon.fit()
})
</script>

<template>
  <div h-full grid="~ rows-[min-content_1fr]">
    <div flex="~ gap-2 items-center" px4 py2 border="b base dashed" bg-faded>
      <div i-ph-terminal-window-duotone />
      <span text-sm>Terminal</span>
      <div ml-auto i-ep-arrow-down-bold cursor-pointer @click="hiddenTerminal" />
    </div>
    <div ref="root" w-full h-full of-hidden />
  </div>
</template>
